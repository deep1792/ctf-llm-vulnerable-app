name: CTF DevSecOps Pipeline

on:
  push:
    branches: [master, develop]
  pull_request:
    branches: [master]

env:
  DOCKER_IMAGE: ctf-llm-app

jobs:
  security-scan:
    name: Security Scanning
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
        
    - name: Install dependencies
      run: |
        cd src
        pip install -r requirements.txt
        
    - name: Run Bandit SAST
      run: |
        pip install bandit
        echo "Running Bandit SAST scan - intentional vulnerabilities expected for CTF"
        bandit -r src/ -f txt --exit-zero
        echo "Bandit scan completed successfully"

    - name: Run Semgrep with CTF-specific rules
      run: |
        pip install semgrep
        echo "Running Semgrep - excluding public host rule for CTF deployment"
        semgrep --config=p/ci --exclude-rule=python.flask.security.audit.app-run-param-config.avoid_app_run_with_bad_host
        echo "Semgrep completed - CTF public host binding is intentional"

  container-build:
    name: Container Build & Security
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Build Docker image
      run: |
        docker build -t ${{ env.DOCKER_IMAGE }}:latest .
        echo "Docker image built successfully"
        
    - name: Scan container with Trivy (non-blocking for CTF)
      run: |
        echo "Running Trivy scan - vulnerabilities in dependencies will be documented but not block deployment"
        docker run --rm -v /var/run/docker.sock:/var/run/docker.sock aquasec/trivy:latest image --exit-code 0 --severity HIGH,CRITICAL ${{ env.DOCKER_IMAGE }}:latest
        echo "Trivy scan completed - vulnerabilities documented"

  final-report:
    name: Final Report
    runs-on: ubuntu-latest
    needs: [security-scan, container-build]
    
    steps:
    - name: Generate Final Report
      run: |
        echo "CTF LLM Application - Security Pipeline Complete" > $GITHUB_STEP_SUMMARY
        echo "All security scans completed successfully" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "Security Tools Executed:" >> $GITHUB_STEP_SUMMARY
        echo "- Bandit: Code security analysis" >> $GITHUB_STEP_SUMMARY
        echo "- Semgrep: Security pattern detection" >> $GITHUB_STEP_SUMMARY
        echo "- Trivy: Container vulnerability scanning" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "Note: For CTF applications, dependency vulnerabilities are documented but do not block deployment" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "Application is ready for AWS deployment" >> $GITHUB_STEP_SUMMARY
        echo "Docker image: ${{ env.DOCKER_IMAGE }}:latest" >> $GITHUB_STEP_SUMMARY
